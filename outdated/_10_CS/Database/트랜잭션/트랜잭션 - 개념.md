# 트랜잭션

## 트랜잭션이란? 

- **_DBMS에서 데이터를 다루는 논리적인 작업 단위_**
- DB의 `무결성`을 유지하며 DB의 상태를 변화시키는 기능 수행
- 트랜잭션이 필요한 이유
  - DB에서 데이터를 다룰 때 장애가 일어나는 경우, 트랜잭션은 ***장애 발생 시 데이터를 복구하는 작업의 단위가 된다.***
  - DB에서 **_여러 작업이 동시에 같은 데이터를 다룰 때, 트랜잭션은 이 작업을 서로 분리하는 단위가 된다._**
- 예) _은행 시스템에서 A에게 100만원을 출금해서 B에게 입금할 때 장애가 생겨 B에게 100만원이 입금이 되지 않았다._ 
  - 이런 상황은 전산시스템의 치명적인 오류
  - 이처럼 예상치 못하게 데이터 부정합이 발생하는 경우 다시 원상복귀시켜야한다.
  - 출금을 했으면 입금을 마치든지, 아니면 아예 없던 일이 되어야한다.

## 트랜잭션의 성질 - ACID 원칙 

트랜잭션은 데이터베이스의 무결성을 유지하기 위해 원자성, 일관성, 고립성, 지속성의 성질을 갖는다.

### Atomicity(원자성)

- 트랜잭션에 포함된 작업은 _**전부 수행되거나, 아니면 전부 수행되지 않아야 한다**_(`all or nothing`)라는 원칙
- 트랜잭션 중간에 장애가 발생하면 롤백을 통해 원자성을 보장한다. 

### Consistency(일관성)

- 트랜잭션을 수행하기 전이나 수행한 후나 데이터베이스는 항상 일관된 상태를 유지해야한다.
- 테이블이 생성될 때 CREATE 문과 ALTER 테이블 문의 무결성 제약조건을 통해 명시된다.
- 일관된 상태란?
  - 일관성 조건은 데이터베이스를 사용하는 상황에 따라 다르다.
  - 계좌이체 상황에서 A계좌에서 돈을 인출에서 B계좌에 입금한다고 해보자. 각 계좌에는 10만원씩 들어있다고 했을 때, 두 계좌의 금액 총합은 20만언이어야 한다. 이 때 `계좌의 합이 20만원이어야 한다`라는 것이 일관성 조건이 된다.  
  - 트랜잭션 도중에 A계좌에서 만 원을 인출하고 B계좌에 입금하지 않은 시점에서는 두 계좌의 합이 20만원이 아니라 19만원이 된다. 즉 일관성을 일시적으로 지키지 못한 상태가 된다. 
  - 트랜잭션을 마치고 나면 다시 두 계좌의 합은 20만원이 된다. 즉 일관성 조건을 만족시킨다.
- 송금 전후 모두 잔액의 Data Type이 Integer이어야 한다는 것이 일관성의 한 예가 될 수 있다.

### Isolation(격리성)

- 여러 트랜잭션은 동시에 수행되는데, 이 때 수행 중인 트랜잭션에 다른 트랜잭션이 끼어들어 변경 중인 데이터 값을 훼손하는 일이 없어야함을 의미.
- 여러 트랜잭션이 같은 데이터를 동시에 읽고 쓸 경우, 변경 중인 데이터를 다른 트랜잭션이 사용하면 데이터의 일관성이 훼손될 수 있다.
- DBMS는 `동시성 제어` 또는 `트랜잭션 고립 수준에 따라 트랜잭션의 상호 간섭을 완화`시키는 방법을 통해 고립성을 보장한다.
  - 동시성 제어: 동시에 수행되는 트랜잭션이 동일한 데이터를 가지고 충돌하지 않도록 제어 
- `고립성 현상`: 여러 트랜잭션이 동시에 수행될 때 상호 간섭이나 데이터 충돌이 일어나지 않는 현상

### Durability(지속성)

- 트랜잭션이 정상적으로 완료된 데이터는 반드시 데이터베이스에 저장되어야함을 의미.
- 트랜잭션이 완료되어 저장된 데이터베이스는 저장 후에 생기는 정전, 장애, 오류에 영향을 받지 말아야한다. 
- DBMS는 `회복 기능`을 통해 DB를 원래 상태로 복구하여 `지속성`을 보장한다.

### 트랜잭션의 특성을 지원하는 DBMS의 기능

- DBMS의 회복 기능과 병행 제어 기능을 통해 ACID를 보장한다.
- 회복 기능 👉 원자성, 지속성
- 병행 제어 기능 👉 일관성, 격리성

### 트랜잭션 상태

![](https://blog.kakaocdn.net/dn/bbYMDH/btrbOsjZF2N/le9kHXH4DkZIb67wbfoFw0/img.png)

- 활동(Active)
  - 트랜잭션이 수행되기 시작하여 현재 수행 중인 상태를 활동 상태라고한다.
- 부분완료(Partially Committed)
  - 트랜잭션 수행은 완료되었지만 트랜잭션 수행 결과를 DB에 반영하지 않은 상태
- 완료(Committed)
  - `부분완료` 상태에서 DBMS가 최종적으로 변경내용을 DB에 기록하면 `완료(committed)`상태가 된다.
- 실패(Failed)
  - 트랜잭션을 중간에 중단했거나, 부분완료 상태에서 변경 내용을 DB에 저장하지 못한 상태.
- 철회(Aborted)
  - 트랜잭션을 수행하는데 실패하여, rollback 연산을 수행한 상태
  - 트랜잭션이 `철회` 상태가 되면 트랜잭션이 수행되기 전의 상태로 원상복구한다.  

---

**※ Reference**

- [MySQL로 배우는 데이터베이스 개론과 실습](http://www.yes24.com/Product/Goods/77724190)

---

## 🗣️ 면접 대비

### Q. 트랜잭션이란?

- 트랜잭션이란 데이터베이스 내에서 수행되는 작업의 최소 단위
- 데이터베이스의 무결성을 유지하며 DB의 상태를 변화시키는 기능 수행
  - `무결성`: 데이터베이스에 저장된 데이터의 정확성을 지키는 것 
- 트랜잭션은 하나 이상의 쿼리를 포함해야하고, ACID라고 불리는 원자성, 일관성, 고립성, 지속성 4가지 규칙을 만족해야한다. 

### Q. ACID 원칙?

### Q. COMMIT과 ROLLBACK에 대해 설명해보세요.

- 데이터베이스는 `COMMIT` 과 `ROLLBACK` 명령어를 통해 데이터 무결성을 보장한다. 
- `COMMIT`이란 트랜잭션 작업을 완료했다고 확정하는 명령어이다.
  - 트랜잭션 작업 내용을 실제 DB에 저장하고, DB가 변경된다.
- `ROLLBACK`은 작업 중 문제가 발생했을 때, 트랜잭션 처리과정에서 발생한 변경 사항을 취소하고, 이전 `COMMIT`의 상태로 되돌린다.

### Q. ACID 원칙 중, Durability를 DBMS는 어떻게 보장하나요?

### Q. 트랜잭션을 사용해 본 경험이 있나요? 어떤 경우에 사용할 수 있나요?

### Q. DeadLock이 뭔지 설명해주세요.

- DeadLock이란 여러 트랜잭션들이 각각 자신의 데이터에 대하여 락을 획득한 상태에서, 상대방 데이터 대하여 접근하고자 대기를 할 때 교차 대기를 하게 되면서 서로 영원히 기다리는 상태를 말한다.

### Q. Deadlock 을 해결하려면 어떻게 해야 하나요?

- 각 트랜잭션이 실행되기 전에  사용될 모든 데이터를 미리 Locking 해주는 `예방 기법`
- 자원 할당시 time stamp를 사용하여 데드락이 발생하지 않도록 하는 `회피하는 기법`
- 데드락이 발생하면 이를 감지하고 회복시키는 `탐지/회복 기법`

모든 DBMS가 4개의 레벨을 모두 구현하고 있나요? 그렇지 않다면 그 이유는 무엇일까요?
만약 MySQL을 사용하고 있다면, (InnoDB 기준) Undo 영역과 Redo 영역에 대해 설명해 주세요.
그런데, 스토리지 엔진이 정확히 무엇을 하는 건가요?



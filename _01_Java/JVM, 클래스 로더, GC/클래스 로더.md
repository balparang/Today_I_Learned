# 클래스 로더

![image](https://user-images.githubusercontent.com/65555299/231683493-323d86f0-ea99-40e1-aec6-215a2efb9e1a.png)

### 클래스 로더(Class Loader)란?



## 클래스 로더 동작과정 

- 로딩, 링크, 초기화 순으로 진행된다.

### 로딩(loading)

- 클래스 로더가 .class 파일을 읽고 그 내용에 따라 적절한 바이너리 데이터를 만들고 `메소드 영역`에 저장
- 이 때 메소드 영역에 저장되는 데이터
  - FQCN(Fully Qualified Class Name): 클래스가 속한 패키지명을 모두 포함한 이름
  - 클래스, 인터페이스, Enum(이늄)
  - 메소드와 변수
- 로딩이 끝나면 해당 클래스 타입의 `Class 객체`를 생성하여 `힙 영역`에 저장
  ```java
  public static void main(String[] args) {
    // Class 타입의 인스턴스가 해당클래스.class에 저장 
    Class<WhiteShip> whiteShipClass = WhiteShip.class; 
  }
- 로딩 동작과정 
  - 특정 클래스를 읽을 때,
  - 최상위 부모 클래스 로더(부트스트랩 클래스 로더)에게 먼저 요청
  - 부트스트랩 클래스 로더 로더가 못 읽으면 하위 클래스 로더(플랫폼 클래스 로더)에게 읽도록 요청
  - 플랫폼 클래스 로더도 못 읽으면 애플리케이션 클래스 로더가 읽음
    - 애플리케이션 클래스 로더도 못 읽으면 `NotFoundException` 발생

- 클래스 로더는 계층 구조로 이뤄져 있으면 기본적으로 3가지 클래스 로더를 제공한다.
  - **부트 스트랩 클래스 로더**
    - `JAVA_HOME\lib`에 있는 코어 자바 API를 제공한다. 
    - 최상위 우선순위를 가진 클래스 로더
  - **플랫폼 클래스 로더** 
    - `JAVA_HOME\lib\text` 폴더 또는 `java.ext.dirs` 시스템 변수에 해당하는 위치에 있는 클래스를 읽는다.
    - (예전 자료들에서는 Extension Class Loader 라고 부른다.) 
  - **애플리케이션 클래스 로더** 
    - 애플리케이션 `클래스패스`(애플리케이션 실행할 때 주는 `-classpath 옵션` 또는 `java.class.path 환경 변수의 값에 해당하는 위치`)에서 클래스를 읽는다.

![image](https://user-images.githubusercontent.com/65555299/231696516-1effe824-aba5-4b8c-a01f-954a50d6ae6f.png)

```java
public static void main(String[] args) {
    ClassLoader classLoader = App.class.getClassLoader();
    System.out.println(classLoader);
    System.out.println(classLoader.getParent());
    System.out.println(classLoader.getParent().getParent());
}

// 실행 결과
jdk.internal.loader.ClassLoaders$AppClassLoader@6a6824be
jdk.internal.loader.ClassLoaders$PlatformClassLoader@75bd9247
null
```

### 링크(linking)

- Verify, Prepare, Resolve(optional) 세 단계로 나뉘어있다.
- Verify
  - `.class 파일`이 유효한지 체크한다.
  - 유효하지 않으면 실행하다가 JVM단에서 에러가 나니까 앱이 죽는다.
- Prepare
  - 클래스 변수(static 변수)와 기본값에 필요한 메모리를 준비하는 과정. 
- Resolve(optional)
  - 심볼릭 메모리 레퍼런스를 메소드 영역에 있는 실제 레퍼런스로 교체한다.
  - 메소드 영역에 있는 실제 레퍼런스로 교체하는 것은 링크 과정에서 일어날 수도 있고 일어나지 않을 수 있다(optional). 
  ```java
  public class App {
  
      // Symbolic Reference. 논리적인 레퍼런스.
      // 코드를 읽었다 하더라도 실제 사용되기 전까지 실제 인스턴스를 가리키지는 않는다.
      Book book = new Book();
  
      public static void main(String[] args) {
      }
  }
  ```

### 초기화(initialization)

- Static 변수의 값을 할당한다. (static 블럭이 있다면 이때 실행된다.)


<br>

**※ Reference**

- [[인프런] 백기선 - 더 자바, 코드를 조작하는 다양한 방법](https://www.inflearn.com/course/lecture?courseSlug=the-java-code-manipulation&unitId=23414&tab=curriculum)
- https://tecoble.techcourse.co.kr/post/2021-07-15-jvm-classloader/
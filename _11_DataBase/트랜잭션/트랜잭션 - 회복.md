# 트랜잭션 - 회복

### 회복이란?

- `회복`은 장애가 발생했을 때 데이터베이스를 장애가 발생하기 전의 일관된 상태로 복구시키는 것이다.
- DBMS의 회복 관리자(recover manager)가 회복을 담당한다. 

### 장애 

- 트랜잭션의 논리적 오류, 잘못된 데이터 입력 등으로 `트랜잭션 장애`가 발생할 수 있다.

# 회복 기법 

### 회복 연산

DB는 데이터를 별도의 장소에 미리 복사해두고, 장애로 문제가 발생했을 때 복사본을 이용해 원래의 상태로 복원한다. DB에 변경연산이 실행될 때마다 데이터를 변경하기 이전값과 변경한 이후 값을 별도 파일에 기록하는데, 이것을 `로그`라고 한다.

- `redo(재실행)`: 
  - 로그에 기록된 변경 후의 값을 이용하여 변경 연산을 재실행 
  - 데이터베이스의 복사본을 가져온 후 로그를 이용해 복사본이 만들어진 이후에 실행된 모든 변경 연산을 재실행
- `undo(취소)`
  -  로그에 기록된 변경 연산 이전의 값을 이용하여 변경 연산을 취소  

## 로그 회복 기법

데이터를 변경한 연산 결과를 데이터베이스에 반영하는 시점에 따라 즉시 갱신 회복 기법과 지연 갱신 회복 기법으로 나눈다.

### 즉시 갱신 회복 기법

트랜잭션 수행 중에 데이터를 변경한 연산의 결과를 데이터베이스에 즉시 반영한다. 장애 발생에 대비하기 위해 데이터 변경에 대한 내용(=로그 레코드)를 로그 파일에도 기록한다. 

- 트랜잭션 완료 전 장애 발생
  - `undo` 연산을 통해 데이터를 변경 이전의 값으로 원상복구한다.
- 트랜잭션 완료 후 장애 발생
  - `redo` 연산을 통해 트랜잭션 중 변경 연산을 다시 적용한다.

### 지연 갱신 회복 기법

트랜잭션이 수행되는 동안에는 데이터 변경 연산 결과를 데이터베이스에 즉시 반영하지 않고 로그 파일에만 기록하고, 트랜잭션이 `부분 완료`된 후에 로그에 기록된 내용을 데이터베이스에 한 번에 반영하는 방식.

- 트랜잭션 완료 전 장애 발생
  - 해당 트랜잭션에 대한 로그 레코드를 무시한다. 즉, 별도의 회복조치가 필요없다. 
- 트랜잭션 완료 후 장애 발생
  - `redo` 연산을 통해 변경 연산 내용을 다시 적용한다. 

## 검사 시점 회복 기법(체크포인트 회복기법)

- `로그 회복 기법`은 로그 전체를 분석하여 모든 트랜잭션을 대상으로 redo나 undo 중 적용할 회복 연산을 정해야하므로 **_회복에 많은 시간이 필요_**  
- 체크포인트 회복 기법은 로그 회복 기법과 같은 방식으로 로그를 기록하되, 일정 시간 간격으로 체크포인트를 만들어둔다. 
  - 장애가 발생 시 체크포인트 이전의 트랜잭션에 대해서는 회복 작업을 수행하지 않고, 체크포인트 이후의 트랜잭션에 대해서만 회복 작업을 수행
- **_불필요한 회복 작업을 수행하지 않아 회복 시간 단축_**


## 미디어 회복 기법

- 디스크 고장 등으로 장애가 발생하면 데이터베이스 사용 불가능
- `미디어 회복 기법`은 일정 주기로 전체 데이터베이스의 내용을 다른 안전한 저장 장치에 복사해두는 `덤프`를 사용